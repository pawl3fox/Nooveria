# –¢–µ—Ö –æ–±–∑–æ—Ä

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
**–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∞—Ä–±–∏—Ç—Ä–∞–∂–∞ —Ç–æ–∫–µ–Ω–æ–≤** —Å –æ—Ç—Ä–∞—Å–ª–µ–≤–æ–π –∑–∞—â–∏—Ç–æ–π –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π —Å –ø–æ–º–æ—â—å—é –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —è–¥—Ä–∞

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
- **–ë—ç–∫–µ–Ω–¥**: FastAPI (Python) + PostgreSQL + Redis
- **–§—Ä–æ–Ω—Ç–µ–Ω–¥**: React + Vite
- **–†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ**: Docker Compose
- **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: —Ç–æ–∫–µ–Ω—ã JWT
- **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤**: –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. –°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (`backend/app/services/device_tracking.py`)
```python
class DeviceTracker:
    def create_device_signatures(self, fingerprint_data):
        # –ü–µ—Ä–≤–∏—á–Ω—ã–π: –ü–æ–ª–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
        # –í—Ç–æ—Ä–∏—á–Ω—ã–π: –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–º—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é
        # –¢—Ä–µ—Ç–∏—á–Ω—ã–π: –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –±–∞–∑–æ–≤–æ–º—É –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é
        
    def find_matching_device(self, db, fingerprint_data):
        # –¢–µ—Å—Ç–æ–≤–∞—è: –ø–µ—Ä–≤–∏—á–Ω—ã–π ‚Üí –≤—Ç–æ—Ä–∏—á–Ω—ã–π ‚Üí —Ç—Ä–µ—Ç–∏—á–Ω—ã–π
        # –û–±–Ω–æ–≤–∏—Ç–µ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ**: –¢–æ—á–Ω–æ–µ ‚Üí –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ–µ ‚Üí –ë–∞–∑–æ–≤–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
- **–ö—Ä–æ—Å—Å–±—Ä–∞—É–∑–µ—Ä–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ**: –û–¥–Ω–æ –∏ —Ç–æ –∂–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤–æ –≤—Å–µ—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö
- **–≠–≤–æ–ª—é—Ü–∏—è —Å–∏–≥–Ω–∞—Ç—É—Ä—ã**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –±–æ–ª—å—à–µ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
- **–§–æ–∫—É—Å –Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–∏**: –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞, —ç–∫—Ä–∞–Ω–∞, —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞, –∞—É–¥–∏–æ

#### 2. –°–∏—Å—Ç–µ–º–∞ –∫–æ—à–µ–ª—å–∫–∞ (`backend/app/services/wallet.py`)
```python
def charge_tokens(db, user_id, total_tokens, prefer_communal=False):
    # –ê—Ç–æ–º–∞—Ä–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    personal_wallet = db.query(Wallet).with_for_update().first()
    # –õ–∏—á–Ω—ã–π —Å—á—ë—Ç ‚Üí –æ–±—â–∞–∫ ‚Üí –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–ø–ª–∞—Ç—ã:**
1. –õ–∏—á–Ω—ã–π –∫–æ—à–µ–ª—ë–∫ (–ø—Ä–∏–æ–±—Ä–µ—Ç—ë–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã)
2. –û–±—â–∏–π –∫–æ—à–µ–ª—ë–∫ (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ —Å –¥–Ω–µ–≤–Ω—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏)
3. –û—à–∏–±–∫–∞ ¬´–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤¬ª

#### 3. –ü—Ä–æ–∫—Å–∏ OpenAI (`backend/app/services/openai_client.py`)
```python
async def chat_completion(messages, model="gpt-3.5-turbo"):
    # –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π + –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    # –†–µ–∂–∏–º –∏–º–∏—Ç–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    # –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —á–∞—Ç–∞
```

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- **–ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**: –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **–ú–æ–¥–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º**: —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ OpenAI
- **–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å**: —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —á–∞—Ç–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

## üîÑ –ö–æ–Ω–≤–µ–π–µ—Ä –ø–æ—Ç–æ–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

### 1. –ü–æ—Ç–æ–∫ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
Browser ‚Üí Device Fingerprint ‚Üí Multi-tier Matching ‚Üí User Binding ‚Üí JWT Token
```

**–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:**
```javascript
// Frontend: Collect hardware signals
const fingerprint = {
    screen: "1920x1080x24x24",
    webglRenderer: "nvidia-gtx-1060", 
    hardwareConcurrency: 8,
    deviceMemory: 8
}

// Backend: Multi-tier matching
signatures = {
    primary: hash(screen + gpu + cpu + timezone),
    secondary: hash(screen + gpu + platform),
    tertiary: hash(screen + timezone + platform)
}
```

### 2. –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—Ä–æ—Å–∞ —á–∞—Ç–∞
```
–í–∞–ª–∏–¥–∞—Ü–∏—è JWT ‚Üí User extraction ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—à–µ–ª—å–∫–∞ ‚Üí –û—Ü–µ–Ω–∫–∞ —Ç–æ–∫–µ–Ω–∞ ‚Üí
–ê—Ç–æ–º–∞—Ä–Ω—ã–π –±–∏–ª–ª–∏–Ω–≥ ‚Üí –ü—Ä–æ–∫—Å–∏ OpenAI ‚Üí –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ‚Üí –û—Ç–≤–µ—Ç
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- **–ê—Ç–æ–º–∞—Ä–Ω—ã–π –±–∏–ª–ª–∏–Ω–≥**: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ –≥–æ–Ω–æ–∫
- **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∞—Ç–∞**: –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π FastAPI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

### 3. –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞—Ç—É—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤
```python
# –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
device = find_by_primary_signature(fingerprint_hash)
\
# –§–æ–ª–±–µ–∫ –Ω–∞ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
if not device:
    device = find_by_secondary_signature(screen + gpu)
    if device:
        device.fingerprint_hash = primary_signature  # Upgrade

# –§–æ–ª–±–µ–∫ –Ω–∞ –±–∞–∑–æ–≤–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
if not device:
    device = find_by_tertiary_signature(screen + timezone)
    if device:
        device.fingerprint_hash = primary_signature  # Upgrade
```

## –ú–µ—Ö–∞–Ω–∏–∑–º—ã –ø—Ä–æ—Ç–∏–≤–æ–¥–µ–π—Å—Ç–≤–∏—è –∞–±—å—é–∑—É

### –£—Ä–æ–≤–Ω–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤

#### –£—Ä–æ–≤–µ–Ω—å 1: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
- **–ú–æ–¥–µ–ª—å –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞**: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ —Ä–µ–Ω–¥–µ—Ä–µ—Ä–∞ WebGL
- **–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —ç–∫—Ä–∞–Ω–∞**: –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ + –≥–ª—É–±–∏–Ω–∞ —Ü–≤–µ—Ç–∞ + –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
- **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ**: –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–µ—Ä)
- **–ê—É–¥–∏–æ–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ**: –ß–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏ + –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–∞–Ω–∞–ª–æ–≤

#### –£—Ä–æ–≤–µ–Ω—å 2: –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã
- **–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞**: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
- **–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å**: –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å —Å–∏—Å—Ç–µ–º—ã + —Å–º–µ—â–µ–Ω–∏–µ UTC
- **–Ø–∑—ã–∫**: –Ø–∑—ã–∫–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞
- **–°–µ—Ç—å**: –¢–∏–ø –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è + –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å

#### –£—Ä–æ–≤–µ–Ω—å 3: –ö—Ä–æ—Å—Å–±—Ä–∞—É–∑–µ—Ä–Ω–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
```python
def normalize_gpu(gpu_string):
    # "ANGLE (NVIDIA GeForce RTX 4060)" ‚Üí "nvidia-rtx-4060"
    # –£–¥–∞–ª–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –¥–ª—è –¥—Ä–∞–π–≤–µ—Ä–∞/API
    # –£–¥–µ–ª–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –º–æ–¥–µ–ª–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
```

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è —ç–≤–æ–ª—é—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–∏
```python
# –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –≤—Ç–æ—Ä–∏—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
if device_found_via_secondary_signature:
    device.fingerprint_hash = primary_signature
    db.commit()
    # –í –±—É–¥—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è –ø–æ–¥–ø–∏—Å—å
```

## –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
```sql
-- Device fingerprints with multi-tier signatures
device_fingerprints (
    id SERIAL PRIMARY KEY,
    fingerprint_hash VARCHAR(64),     -- –û—Å–Ω–æ–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å—å
    device_metadata JSONB,            -- –í—Å–µ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã + –ø—Ä–æ—Ñ–∏–ª—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
    bound_user_id UUID REFERENCES users(id),
    created_at TIMESTAMP,
    last_seen_at TIMESTAMP
);

-- –ê–∫–∫–∞—É–Ω—Ç—ã —é–∑–µ—Ä–æ–≤ (anonymous \ registered)
users (
    id UUID PRIMARY KEY,
    email VARCHAR(255) UNIQUE,        -- NULL –¥–ª—è –∞–Ω–æ–Ω–∏–º—É—Å–æ–≤
    role_id INTEGER REFERENCES roles(id),
    display_name VARCHAR(100),
    created_at TIMESTAMP
);

-- Token wallets (personal + communal)
wallets (
    id SERIAL PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    type wallet_type,                 -- –ª–∏—á–Ω—ã–π –∏–ª–∏ –æ–±—â–∞–∫
    balance_tokens DECIMAL(15,2),
    created_at TIMESTAMP
);

-- Atomic transaction log
transactions (
    id SERIAL PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    type transaction_type,            -- debit –∏–ª–∏ credit
    amount_tokens DECIMAL(15,2),
    description TEXT,
    created_at TIMESTAMP
);
```

### –ò–Ω–¥–µ–∫—Å—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```sql
CREATE INDEX idx_device_fingerprint_hash ON device_fingerprints(fingerprint_hash);
CREATE INDEX idx_device_bound_user ON device_fingerprints(bound_user_id);
CREATE INDEX idx_transactions_user_date ON transactions(user_id, created_at);
CREATE INDEX idx_usage_records_date ON usage_records(created_at);
```

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±—ç–∫–µ–Ω–¥–∞
```python
# –ü—É–ª HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
http_client = httpx.AsyncClient(
    limits=httpx.Limits(max_connections=100, max_keepalive_connections=20)
)

# Redis –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
cache.setex(f"wallet:{user_id}", 300, wallet_data)  # 5min TTL
cache.incrby(f"daily_usage:{user_id}", tokens)      # Daily counters
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **–ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**: PgBouncer –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫**: `SELECT ... FOR UPDATE` –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∫–æ—à–µ–ª—å–∫–æ–º
- **–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã**: SQLAlchemy ORM —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤**: –≤—Å–µ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ –∏ —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–µ —Å—Ç–æ–ª–±—Ü—ã

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
```javascript
// –≠—Ñ. –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–Ω–≥–µ—Ä–ø–µ—Ä–∏–Ω—Ç–æ–≤
const fingerprint = generateDeviceFingerprint();
// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ —Å—Ç—Ä–æ–∫—É JSON –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
authService.createAnonymousSession(fingerprint);
```

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
- **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —á–∞—Ç–æ–≤**: —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- **HMAC-–æ—Ç–ø–µ—á–∞—Ç–∫–∏**: –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Ö–µ—à–∏—Ä—É—é—Ç—Å—è
- **JWT-—Ç–æ–∫–µ–Ω—ã**: –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞–º–∏ —Å –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
- **–°–µ–∫—Ä–µ—Ç—ã —Å—Ä–µ–¥—ã**: –∫–ª—é—á–∏ API —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—ã

### –ü—Ä–æ—Ü–µ—Å—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
```python
def get_current_user(authorization: str = Header(None)):
    token = authorization.split(" ")[1]  # –ò–∑–≤–ª–µ—á—å —Ç–æ–∫–µ–Ω –Ω–∞ –ø—Ä–µ–¥—ä—è–≤–∏—Ç–µ–ª—è
    payload = verify_token(token)        # –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT
    return payload["sub"]                # –í–µ—Ä–Ω—É—Ç—å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã –æ–±—â–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ**: –ê–ø–ø–∞—Ä–∞—Ç–Ω–æ–µ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ IP**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ç–∏
- **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–æ–ª–µ–π**: –†–∞–∑–ª–∏—á–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üìä –ë–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞

### –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–æ—Ö–æ–¥–æ–≤
```sql
-- –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ñ–∏—Ç–∞ —Ä–∏–∞–ª-—Ç–∞–π–º
SELECT 
    SUM(amount_tokens) * 0.003 / 1000 as revenue_usd,
    SUM(amount_tokens) * 0.002 / 1000 as openai_cost_usd,
    SUM(amount_tokens) * 0.001 / 1000 as profit_usd
FROM transactions 
WHERE type = 'debit' AND created_at >= CURRENT_DATE;
```

### –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```sql
-- –ê–Ω–∞–ª–∏–∑ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
SELECT 
    COUNT(DISTINCT fingerprint_hash) as unique_devices,
    COUNT(DISTINCT bound_user_id) as unique_users,
    AVG(EXTRACT(EPOCH FROM (last_seen_at - created_at))/86400) as avg_retention_days
FROM device_fingerprints;
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

### –°—Ä–µ–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
```yaml
# docker-compose.yml
services:
  backend:    # –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastAPI
  frontend:   # –°–µ—Ä–≤–µ—Ä —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ React  
  postgres:   # –ë–î
  redis:      # –ö—ç—à–∏—Ä—É—é—â–∏–π —Å–ª–æ–π
```

### –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è —Å—Ä–µ–¥–∞
```yaml
# docker-compose.prod.yml
services:
  backend:
    command: uvicorn app.main:app --workers 4  # –ù–µ—Å–∫–æ–ª—å–∫–æ –≤–æ—Ä–∫–µ—Ä–æ–≤
  frontend:
    environment:
      - VITE_API_URL=https://api.yourdomain.com
```

### –í–æ–ø—Ä–æ—Å—ã –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
- **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±—ç–∫–µ–Ω–¥–∞ –∑–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–æ–º –Ω–∞–≥—Ä—É–∑–∫–∏
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**: —Ä–µ–ø–ª–∏–∫–∏ —á—Ç–µ–Ω–∏—è + –ø—É–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π (PgBouncer)
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞**: –∫–ª–∞—Å—Ç–µ—Ä Redis –¥–ª—è –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
- **CDN**: –¥–æ—Å—Ç–∞–≤–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞